###
### Quickness Settings
###

# This should allow for quick sourcing of formulas
export Q=$QUICKNESS/formulas

export QUICKNESS_BIN=$QUICKNESS/bin
export QUICKNESS_ETC=$QUICKNESS/etc
export QUICKNESS_PRIVATE=$QUICKNESS_ETC/private
export QUICKNESS_SCRIPTS=$QUICKNESS/scripts
export QUICKNESS_TWEAKS=$QUICKNESS/tweaks

export QUICKNESS_HOME=$HOME/.quickness
export QUICKNESS_SRC=$HOME/.quickness/src

export QUICKNESS_INSTALLED=$QUICKNESS_HOME/.installed
export QUICKNESS_MSG=/tmp/quickness.msg


###
### Quickness Workspaces
###

if [ ! -d $QUICKNESS_HOME ]; then
    mkdir $QUICKNESS_HOME
fi
if [ ! -d $QUICKNESS_SRC ]; then
    mkdir $QUICKNESS_SRC
fi


###
### Various methods to accumalate messages and keep track of what's been installed
###

if [ -f $QUICKNESS_MSG ]; then
    rm $QUICKNESS_MSG
fi

if [ ! -f $QUICKNESS_INSTALLED ]; then
    echo "#ONLY REMOVE THINGS FROM HERE YOU WANT TO TRY AND REINSTALL" >> $QUICKNESS_INSTALLED
fi

formula_msg() {
    if [ ! -f $QUICKNESS_MSG ]; then
        echo "" >> $QUICKNESS_MSG
    fi
    echo "[${BASH_SOURCE[1]##*/}] $1" >> $QUICKNESS_MSG
    echo "" >> $QUICKNESS_MSG
}

message_printer() {
    # print the messages
    if [ "${#BASH_SOURCE[@]}" = "3" ]; then
        echo "" >> $QUICKNESS_MSG
        cat $QUICKNESS_MSG
        rm $QUICKNESS_MSG
    fi
}

is_formula_installed() {
    if [ ! -z "$(grep ${BASH_SOURCE[1]##*/} $QUICKNESS_INSTALLED)" ]; then
        formula_msg "ALERT: ${BASH_SOURCE[1]##*/} already installed, skipping over"
        message_printer
        return 0
    else
        return 1
    fi
}

formula_init() {
    declare -A formula_vars=$(python $QUICKNESS_SCRIPTS/formula_info.py ${BASH_SOURCE[1]##*/})
    declare FORMULA="`echo ${BASH_SOURCE[1]##*/} | tr '[a-z]' '[A-Z]'`"
    declare KEY

    for key in ${!formula_vars[@]}
    do
        KEY="`echo $key | tr '[a-z]' '[A-Z]'`"
        eval ${FORMULA}_$KEY="${formula_vars["$key"]}"
    done

    eval ${FORMULA}_PREV_DIR=$PWD
}

formula_teardown() {
    # add to installed
    echo "${BASH_SOURCE[1]##*/}" >> $QUICKNESS_INSTALLED

    # print the messages
    message_printer

    # unset any formula specific variables
    declare -A formula_vars=$(python $QUICKNESS_SCRIPTS/formula_info.py ${BASH_SOURCE[1]##*/})
    declare FORMULA="`echo ${BASH_SOURCE[1]##*/} | tr '[a-z]' '[A-Z]'`"
    declare KEY

    for key in ${!formula_vars[@]}
    do
        KEY="`echo $key | tr '[a-z]' '[A-Z]'`"
        eval unset ${FORMULA}_$KEY
    done

    # cd back to original directory
    if [ ! -z "$(eval echo \$${FORMULA}_PREV_DIR)" ]; then
        eval cd \$${FORMULA}_PREV_DIR
        eval unset ${FORMULA}_PREV_DIR
    fi
}


###
### Path
###

export PATH=$QUICKNESS_BIN:$PATH
